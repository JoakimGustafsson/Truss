<!doctype html>
<html>

<head>
	<meta charset="UTF-8" />
	<script src="Javascript/Primitives.js" type="text/javascript"></script>
	<script src="Javascript/FileSave.js" type="text/javascript"></script>
	<script src="Javascript/View.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/Node.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/CollectionNode.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/PictureNode.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/TrussNode.js" type="text/javascript"></script>
	<script src="Javascript/Tensors.js" type="text/javascript"></script>
	<script src="Javascript/Truss.js" type="text/javascript"></script>
	<script src="Javascript/Universe.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/Actuators.js" type="text/javascript"></script>
	<script src="Javascript/Nodes/Sensors.js" type="text/javascript"></script>
	<script src="Javascript/ParameterEditor/Property.js" type="text/javascript"></script>
	<script src="Javascript/ParameterEditor/BannerNode.js" type="text/javascript"></script>
	<script src="Javascript/ParameterEditor/ConfigurationArea.js" type="text/javascript"></script>
	<script src="Javascript/Pictures.js" type="text/javascript"></script>
	<script src="Javascript/ExperimentalTrusses.js" type="text/javascript"></script>

	<link rel="stylesheet" type="text/css" href="../Stylefiles/Truss.css">

	<link rel="icon" type="image/png" href="../Resources/trussIcon.png" />
	<link rel="shortcut icon" href="../Resources/trussIcon.png" />


	<title>Truss</title>

</head>

<body style="background-color: #343f48; margin:0px;" onresize="updateResize()">

	<section>
		<div id="mainArea"></div>

		<div id="FPSdisplay" style="position: absolute; left:10px; bottom:10px; color: white;"></div>

		<script type="text/javascript">
			var savedState = 0;

			var protagonist;
			var universe = new Universe(document.getElementById('mainArea'));

			var setupTicks=3;

			//Main Draw loop
			function mainLoop(timestamp) {
					/* if (newMainNode) {
					universe.current.truss.clear();
					universe.pop();
					universe.current=newMainNode;

					universe.current = newMainNode;

					//universe.current.canvas.onmousemove = myMove;
					//universe.current.canvas.onmousedown = downMouse;
					//universe.current.canvas.onmouseup = upMouse;
					document.getElementById('mainArea').onmousemove = myMove;
					document.getElementById('mainArea').onmousedown = downMouse;
					document.getElementById('mainArea').onmouseup = upMouse;
					newMainNode = undefined;
				}	*/

				universe.tick(timestamp / 1000);

				requestAnimationFrame(mainLoop);
			}

			// Setting up the canvas and ensure other initialization routines are run
			function init() {
				FPSdisplay = document.getElementById("FPSdisplay");

				trussBackground = document.getElementById("temp");


				let mainNode2 = new TrussNode(undefined, new Position(0, 0), new Vector(10, 10), 1 / 60, 1, "StackNode", WalkTruss);
				mainNode2.truss.initiate();
				mainNode2.resize();
				universe.push(new World(mainNode2),[]);

				let mainNode3 = new TrussNode(mainNode2, new Position(0, 0), new Vector(10, 10), 1 / 60, 1, "StackNode2", WalkTruss);
				universe.push(new World(mainNode3),[]);
				mainNode3.truss.initiate();
				mainNode3.resize();

				let latestNode = new TrussNode(mainNode3, new Position(0, 0), new Vector(20, 20), 1 / 60, 1, "MainNode", WalkTruss);
				latestNode.truss.initiate();


				let governorTruss =new TrussNode(latestNode, new Position(0, 0), new Vector(10, 10), 1 / 60, 1, "GovenorTruss", GovenorTruss)
				governorTruss.truss.initiate(protagonist);
				governorTruss.resize();
				let governorList= [governorTruss];

				let latestWorld = universe.push(new World(latestNode, governorList));
				latestNode.resize();

				universe.setCurrentWorld(latestWorld);

				// universe.showUniverse(document.getElementById('mainArea'));

				window.requestAnimationFrame(mainLoop);


				document.getElementById('mainArea').onmousemove = myMove;

				//	document.getElementById('mainArea').onmousedown = downMouse;
				//	document.getElementById('mainArea').onmouseup = upMouse;


				document.addEventListener('selectionEvent',
					function (e) {
						select.call(this, e);
					}, false);


				openBottomPanel(event, 'propertiesDiv');

				universe.currentNode.element.display = "none";
				updateResize();

			}



			let myX = 3;
			let myY = 3;
			let mouseSet = false;
			/**
			 * @param  {Event} e
			 */
			function myMove(e) {
				myX = e.pageX;
				myY = e.pageY;
			}

			/**
			 * @param  {Event} e
			 */
			function downMouse(e) {
				mouseSet = true;
			}

			/**
			 * @param  {Event} e
			 */
			function upMouse(e) {
				mouseSet = false;
			}



			function openBottomPanel(evt, divName) {
				// Declare all variables
				var i, tabcontent, tablinks;

				// Get all elements with class="tabcontent" and hide them
				tabcontent = universe.currentNode.getElements('.tabcontent');
				// document.getElementsByClassName("tabcontent");
				for (i = 0; i < tabcontent.length; i++) {
					tabcontent[i].style.display = "none";
				}

				// Get all elements with class="tablinks" and remove the class "active"
				tablinks = universe.currentNode.getElements('.tabsectionbuttons');
				//document.getElementsByClassName("tabsectionbuttons");
				for (i = 0; i < tablinks.length; i++) {
					tablinks[i].classList.remove("active");
				}

				// Show the current tab, and add an "active" class to the button that opened the tab
				universe.currentNode.getElement('#'+divName).style.display = "block";

				if (evt)
					evt.currentTarget.classList.add("active");
				else
				universe.currentNode.getElement('#'+"propertiesButton").classList.add("active");
			}


			/**
			 * @param  {Event} selectionEvent
			 */
			function select(selectionEvent) {
				let select = selectionEvent.detail.selectedObject;
				let connectionDiv= universe.currentNode.getElement("#connectionDiv");

				if (!select) {
					connectionDiv.innerHTML = '';
					return;
				}
				let previousSelectedObject = selectionEvent.detail.previousSelectedObject;
				select.setHighlight(2);
				if (previousSelectedObject) {
					previousSelectedObject.setHighlight(0);
				}


				connectionDiv.innerHTML = '';
				connectionDiv.appendChild(select.generateconnectionHTML());

				let gravityButton= universe.currentNode.getElement("#gravityButton");
				let tensorAdder= universe.currentNode.getElement("#tensorAdder");

				if (select.isNode) {
					gravityButton.style.display = 'inline';
					tensorAdder.style.display = 'inline';
				} else {
					gravityButton.style.display = 'none';
					tensorAdder.style.display = 'none';
				}
			}

			function makeNode() {
				let selector = document.getElementById('nodeType');
				let value = selector.value;
				if (value == 'Node') {
					universe.currentNode.truss.addNode(new Node(universe.currentNode.truss, new Position(1, 1), 10, 'node'));
				}
			}

			var connectionTensor;
			var connectionEventListener;

			function makeTensor() {
				let selector = universe.currentNode.getElement('#tensorType');
				let value = selector.value;
				if (value == 'Spring') {
					connectionTensor = universe.currentNode.truss.addTensor(new Spring(universe.selectedObject, universe.currentNode.selector, 100));
				} else if (value == 'DampenedSpring') {
					connectionTensor = universe.currentNode.truss.addTensor(new DampenedSpring(universe.selectedObject,  universe.currentNode.selector, 100));
				} else if (value == 'PullSpring') {
					connectionTensor = universe.currentNode.truss.addTensor(new PullSpring(universe.selectedObject,  universe.currentNode.selector, 100));
				} else if (value == 'Absorber') {
					connectionTensor = universe.currentNode.truss.addTensor(new Absorber(universe.selectedObject,  universe.currentNode.selector, 1));
				} else if (value == 'Field') {
					connectionTensor = universe.currentNode.truss.addTensor(new Field(universe.selectedObject,  universe.currentNode.selector, 0.0001));
				} else if (value == 'PictureSpring') {
					connectionTensor = universe.currentNode.truss.addTensor(new PictureSpring(universe.selectedObject,  universe.currentNode.selector, 100, 'facade.jpg', 1));
				}
				if (!connectionEventListener) {
					connectionEventListener = document.addEventListener('selectionEvent', function (e) {
						if (connectionTensor && universe.selectedObject.isNode) {
							connectionTensor.sensorAttach();
							connectionTensor = undefined;
						}
					}, false);
				}
			}

			function changeDebugLevel() {
				universe.currentNode.truss.debugLevel = universe.currentNode.getElement("#debugLevel").value;
			}

			function addGravityCheat() {
				universe.current.truss.addTensor(gravityField(universe.selectedObject));
			}

			function deleteSelected() {
				if (universe.selectedObject.isTensor) {
					universe.currentNode.truss.removeTensor(universe.selectedObject);
				} else if (universe.selectedObject.isNode) {
					universe.currentNode.truss.removeNode(universe.selectedObject);
				}
			}

			function selectMainNode() {
				let previousSelectedObject = universe.selectedObject;
				selectedObject = universe.currentNode;
				let event = new CustomEvent('selectionEvent', {
					detail: {
						'selectedObject': selectedObject,
						'previousSelectedObject': previousSelectedObject,
						'truss': selectedObject.truss,
					},
					bubbles: true,
					cancelable: true,
				});
				document.dispatchEvent(event);
			}

			function updateResize() {
				universe.currentNode.resize();
			}

			function movePropertyEdit(configAreaName) {
				if (configAreaName == 'trussConfigArea') {
					selectMainNode();
				}
				let view = universe.currentNode.getElement("#configview");
				let container =universe.currentNode.getElement("#"+configAreaName);
				container.appendChild(view);
			}

			init();
		</script>

	</section>
</body>

</html>